(function(e){"use strict";SAPO.namespace("Ink");var t=SAPO.Ink.Aux,n=SAPO.Dom.Css,r=SAPO.Dom.Element,i=SAPO.Dom.Event,s=function(t,n){if(typeof t!="string"&&typeof t!="object")throw"Invalid Modal selector";if(typeof t=="string"){if(t!==""){this._element=SAPO.Dom.Selector.select(t);if(this._element.length===0)throw"The Modal selector has not returned any elements";this._element=this._element[0]}}else this._element=t;this._options={width:e,height:e,shadownClass:e,markup:e,onShow:e,onDismiss:e,closeOnClick:!1,skipDismiss:!1,resizable:!0,disableScroll:!0},this._handlers={click:this._onClick.bindObjEvent(this),keyDown:this._onKeyDown.bindObjEvent(this),resize:this._onResize.bindObjEvent(this)},this._wasDismissed=!1,this._init(n)};s.prototype={_init:function(e){var n=document.compatMode==="CSS1Compat"?document.documentElement:document.body;this._markupMode=!!SAPO.Dom.Css.hasClassName(this._element,"ink-modal"),this._resizeTimeout=null;if(!this._markupMode)this._modalShadow=document.createElement("div"),this._modalShadowStyle=this._modalShadow.style,this._modalDiv=document.createElement("div"),this._modalDivStyle=this._modalDiv.style,this._options.markup=this._element.innerHTML,this._modalShadow.appendChild(this._modalDiv),document.body.appendChild(this._modalShadow),SAPO.Dom.Css.addClassName(this._modalDiv,"ink-modal"),SAPO.Dom.Css.addClassName(this._modalDiv,"ink-space"),this._modalDivStyle.position="absolute",this._contentContainer=document.createElement("div"),this._contentContainer.className="ink-modal-content",this._contentContainer.innerHTML=[this._options.skipClose?"":'<a href="#" class="ink-close">×</a>',this._options.markup].join(""),this._modalDiv.appendChild(this._contentContainer),document.body.appendChild(this._modalDiv);else{this._modalDiv=this._element,this._modalDivStyle=this._modalDiv.style,this._modalShadow=this._modalDiv.parentNode,this._modalShadowStyle=this._modalShadow.style,this._contentContainer=SAPO.Dom.Selector.select(".modal-body",this._modalDiv);if(!this._contentContainer.length)throw'Missing div with class "ink-modal-body"';this._contentContainer=this._contentContainer[0],this._options.markup=this._contentContainer.innerHTML}SAPO.Dom.Css.addClassName(this._modalShadow,"ink-shade"),SAPO.Dom.Css.addClassName(this._modalShadow,"visible"),SAPO.Dom.Css.addClassName(this._modalDiv,"visible");var r;if("dataset"in this._modalDiv)r=this._modalDiv.dataset;else{r={};for(var s in this._modalDiv.attributes)typeof this._modalDiv.attributes[s]=="object"&&"name"in this._modalDiv.attributes[s]&&this._modalDiv.attributes[s].name.substr(0,5)==="data-"&&(r[this._modalDiv.attributes[s].name.substr(5)]=this._modalDiv.attributes[this._modalDiv.attributes[s].name].value)}this._options=SAPO.extendObj(this._options,r),this._options=SAPO.extendObj(this._options,e||{}),typeof this._options.width!="undefined"?(this._modalDivStyle.width=this._options.width,this._modalDivStyle.maxWidth=SAPO.Dom.Element.elementWidth(this._modalDiv)+"px"):this._modalDivStyle.maxWidth=this._modalDivStyle.width=SAPO.Dom.Element.elementWidth(this._modalDiv)+"px",parseInt(n.clientWidth,10)<=parseInt(this._modalDivStyle.width,10)&&(this._modalDivStyle.width=parseInt(n.clientWidth,10)*.9+"px"),typeof this._options.height!="undefined"?(this._modalDivStyle.height=this._options.height,this._modalDivStyle.maxHeight=SAPO.Dom.Element.elementHeight(this._modalDiv)+"px"):this._modalDivStyle.maxHeight=this._modalDivStyle.height=SAPO.Dom.Element.elementHeight(this._modalDiv)+"px",parseInt(n.clientHeight,10)<=parseInt(this._modalDivStyle.height,10)&&(this._modalDivStyle.height=parseInt(n.clientHeight,10)*.9+"px"),this.originalStatus={viewportHeight:parseInt(n.clientHeight,10),viewportWidth:parseInt(n.clientWidth,10),width:parseInt(this._modalDivStyle.maxWidth,10),height:parseInt(this._modalDivStyle.maxHeight,10)},this._options.resizable&&(this._onResize(),i.observe(window,"resize",this._handlers.resize)),this._contentElement=this._modalDiv,this._shadeElement=this._modalShadow,this._reposition(),this.setContentMarkup(this._options.markup),this._options.onShow&&this._options.onShow(this),this._options.disableScroll&&this._disableScroll(),i.observe(this._shadeElement,"click",this._handlers.click),i.observe(document,"keydown",this._handlers.keyDown),t.registerInstance(this,this._shadeElement,"modal")},_reposition:function(){this._modalDivStyle.top=this._modalDivStyle.left="50%",this._modalDivStyle.marginTop="-"+~~(SAPO.Dom.Element.elementHeight(this._modalDiv)/2)+"px",this._modalDivStyle.marginLeft="-"+~~(SAPO.Dom.Element.elementWidth(this._modalDiv)/2)+"px"},_onResize:function(){this._resizeTimeout||(this._resizeTimeout=setTimeout(function(){var e=document.compatMode==="CSS1Compat"?document.documentElement:document.body,t=parseInt(e.clientHeight,10),n=parseInt(e.clientWidth,10);n>this.originalStatus.viewportWidth?this._modalDivStyle.width=n*this.originalStatus.width/this.originalStatus.viewportWidth+"px":this._modalDivStyle.width=n*.9+"px",t>this.originalStatus.viewportHeight?this._modalDivStyle.height=t*this.originalStatus.height/this.originalStatus.viewportHeight+"px":this._modalDivStyle.height=t*.9+"px",this._resizeContainer(),this._reposition(),this._resizeTimeout=null}.bindObj(this),100))},_onClick:function(e){var t=i.element(e);if(n.hasClassName(t,"ink-close")||n.hasClassName(t,"ink-dismiss")||this._options.closeOnClick&&!r.descendantOf(this._shadeElement,t)||t===this._shadeElement)i.stop(e),this.dismiss()},_onKeyDown:function(e){if(e.keyCode!==27||this._wasDismissed)return;this.dismiss()},_resizeContainer:function(){this._contentElement.style.overflow=this._contentElement.style.overflowX=this._contentElement.style.overflowY="hidden";var e=SAPO.Dom.Element.elementHeight(this._modalDiv);this._modalHeader=SAPO.Dom.Selector.select(".modal-header",this._modalDiv),this._modalHeader.length>0&&(this._modalHeader=this._modalHeader[0],e-=SAPO.Dom.Element.elementHeight(this._modalHeader)),this._modalFooter=SAPO.Dom.Selector.select(".modal-footer",this._modalDiv),this._modalFooter.length>0&&(this._modalFooter=this._modalFooter[0],e-=SAPO.Dom.Element.elementHeight(this._modalFooter)),this._contentContainer.style.height=e+"px";if(this._markupMode)return;this._contentContainer.style.overflow=this._contentContainer.style.overflowX="hidden",this._contentContainer.style.overflowY="auto",this._contentElement.style.overflow=this._contentElement.style.overflowX=this._contentElement.style.overflowY="visible"},_disableScroll:function(){this._oldScrollPos=SAPO.Dom.Element.scroll(),this._onScrollBinded=function(e){var t=SAPO.Dom.Event.element(e);r.descendantOf(this._modalShadow,t)||(SAPO.Dom.Event.stop(e),window.scrollTo(this._oldScrollPos[0],this._oldScrollPos[1]))}.bindObjEvent(this),SAPO.Dom.Event.observe(window,"scroll",this._onScrollBinded),SAPO.Dom.Event.observe(this._modalShadow,"touchmove",this._onScrollBinded)},dismiss:function(){this._options.onDismiss&&this._options.onDismiss(this),this._options.disableScroll&&SAPO.Dom.Event.stopObserving(window,"scroll",this._onScrollBinded),this._options.resizable&&SAPO.Dom.Event.stopObserving(window,"resize",this._handlers.resize);if(!this._markupMode)this._modalDiv.parentNode.removeChild(this._modalDiv);else{SAPO.Dom.Css.removeClassName(this._modalDiv,"visible"),SAPO.Dom.Css.removeClassName(this._modalShadow,"visible");var e;e||(e=setInterval(function(){if(this._modalShadowStyle.opacity>0)return;this._modalShadowStyle.display="none",clearInterval(e)}.bindObj(this),500))}t.unregisterInstance(this._instanceId)},getContentElement:function(){return this._contentContainer},setContentMarkup:function(e){this._markupMode?this._contentContainer.innerHTML=[e].join(""):(this._modalDiv.innerHTML="",this._modalDiv.appendChild(this._contentContainer),this._contentContainer.innerHTML=[this._options.skipClose?"":'<a href="#" class="ink-close">×</a>',e].join("")),this._resizeContainer()}},s.destroy=s.dismiss,SAPO.Ink.Modal=s})();